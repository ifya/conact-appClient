(function(){"use strict";function R(e,t,n,r){function o(i){return i instanceof n?i:new n(function(c){c(i)})}return new(n||(n=Promise))(function(i,c){function v(h){try{p(r.next(h))}catch(E){c(E)}}function m(h){try{p(r.throw(h))}catch(E){c(E)}}function p(h){h.done?i(h.value):o(h.value).then(v,m)}p((r=r.apply(e,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;var q={exports:{}},Ee=q.exports,ie;function ke(){return ie||(ie=1,function(e){(function(t,n){e.exports?e.exports=n():t.log=n()})(Ee,function(){var t=function(){},n="undefined",r=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],i={},c=null;function v(_,C){var y=_[C];if(typeof y.bind=="function")return y.bind(_);try{return Function.prototype.bind.call(y,_)}catch{return function(){return Function.prototype.apply.apply(y,[_,arguments])}}}function m(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function p(_){return _==="debug"&&(_="log"),typeof console===n?!1:_==="trace"&&r?m:console[_]!==void 0?v(console,_):console.log!==void 0?v(console,"log"):t}function h(){for(var _=this.getLevel(),C=0;C<o.length;C++){var y=o[C];this[y]=C<_?t:this.methodFactory(y,_,this.name)}if(this.log=this.debug,typeof console===n&&_<this.levels.SILENT)return"No console available for logging"}function E(_){return function(){typeof console!==n&&(h.call(this),this[_].apply(this,arguments))}}function I(_,C,y){return p(_)||E.apply(this,arguments)}function S(_,C){var y=this,O,A,a,s="loglevel";typeof _=="string"?s+=":"+_:typeof _=="symbol"&&(s=void 0);function u(w){var k=(o[w]||"silent").toUpperCase();if(!(typeof window===n||!s)){try{window.localStorage[s]=k;return}catch{}try{window.document.cookie=encodeURIComponent(s)+"="+k+";"}catch{}}}function l(){var w;if(!(typeof window===n||!s)){try{w=window.localStorage[s]}catch{}if(typeof w===n)try{var k=window.document.cookie,M=encodeURIComponent(s),J=k.indexOf(M+"=");J!==-1&&(w=/^([^;]+)/.exec(k.slice(J+M.length+1))[1])}catch{}return y.levels[w]===void 0&&(w=void 0),w}}function f(){if(!(typeof window===n||!s)){try{window.localStorage.removeItem(s)}catch{}try{window.document.cookie=encodeURIComponent(s)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function b(w){var k=w;if(typeof k=="string"&&y.levels[k.toUpperCase()]!==void 0&&(k=y.levels[k.toUpperCase()]),typeof k=="number"&&k>=0&&k<=y.levels.SILENT)return k;throw new TypeError("log.setLevel() called with invalid level: "+w)}y.name=_,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=C||I,y.getLevel=function(){return a??A??O},y.setLevel=function(w,k){return a=b(w),k!==!1&&u(a),h.call(y)},y.setDefaultLevel=function(w){A=b(w),l()||y.setLevel(w,!1)},y.resetLevel=function(){a=null,f(),h.call(y)},y.enableAll=function(w){y.setLevel(y.levels.TRACE,w)},y.disableAll=function(w){y.setLevel(y.levels.SILENT,w)},y.rebuild=function(){if(c!==y&&(O=b(c.getLevel())),h.call(y),c===y)for(var w in i)i[w].rebuild()},O=b(c?c.getLevel():"WARN");var g=l();g!=null&&(a=b(g)),h.call(y)}c=new S,c.getLogger=function(C){if(typeof C!="symbol"&&typeof C!="string"||C==="")throw new TypeError("You must supply a name when creating a logger.");var y=i[C];return y||(y=i[C]=new S(C,c.methodFactory)),y};var L=typeof window!==n?window.log:void 0;return c.noConflict=function(){return typeof window!==n&&window.log===c&&(window.log=L),c},c.getLoggers=function(){return i},c.default=c,c})}(q)),q.exports}var $=ke(),Q;(function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"})(Q||(Q={}));var H;(function(e){e.Default="livekit",e.Room="livekit-room",e.TokenSource="livekit-token-source",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"})(H||(H={}));let Re=$.getLogger("livekit");Object.values(H).map(e=>$.getLogger(e)),Re.setDefaultLevel(Q.info);const d=$.getLogger("lk-e2ee");var Ce=Object.defineProperty,Pe=(e,t,n)=>t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,se=(e,t,n)=>Pe(e,typeof t!="symbol"?t+"":t,n);class Le{constructor(){se(this,"_locking"),se(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let t;const n=new Promise(o=>t=()=>{this._locks-=1,o()}),r=this._locking.then(()=>t);return this._locking=this._locking.then(()=>n),r}}var B;(function(e){e[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED"})(B||(B={}));class Ke{constructor(){this.pendingTasks=new Map,this.taskMutex=new Le,this.nextTaskIndex=0}run(t){return R(this,void 0,void 0,function*(){const n={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:B.WAITING};this.pendingTasks.set(n.id,n);const r=yield this.taskMutex.lock();try{return n.executedAt=Date.now(),n.status=B.RUNNING,yield t()}finally{n.status=B.COMPLETED,this.pendingTasks.delete(n.id),r()}})}flush(){return R(this,void 0,void 0,function*(){return this.run(()=>R(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const D="AES-GCM",xe=10,ee={key:10,delta:3,audio:1,empty:0},oe=12,Oe={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:xe,keyringSize:16};class Ae extends Error{constructor(t,n,r){super(n||"an error has occurred"),this.name="LiveKitError",this.code=t,typeof r?.cause<"u"&&(this.cause=r?.cause)}}var ae;(function(e){e[e.NotAllowed=0]="NotAllowed",e[e.ServerUnreachable=1]="ServerUnreachable",e[e.InternalError=2]="InternalError",e[e.Cancelled=3]="Cancelled",e[e.LeaveRequest=4]="LeaveRequest",e[e.Timeout=5]="Timeout",e[e.WebSocket=6]="WebSocket",e[e.ServiceNotFound=7]="ServiceNotFound"})(ae||(ae={}));var ce;(function(e){e[e.AlreadyOpened=0]="AlreadyOpened",e[e.AbnormalEnd=1]="AbnormalEnd",e[e.DecodeFailed=2]="DecodeFailed",e[e.LengthExceeded=3]="LengthExceeded",e[e.Incomplete=4]="Incomplete",e[e.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",e[e.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(ce||(ce={}));var V;(function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"})(V||(V={})),function(e){function t(n){if(n&&"name"in n)return n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?e.NotFound:n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?e.PermissionDenied:n.name==="NotReadableError"||n.name==="TrackStartError"?e.DeviceInUse:e.Other}e.getFailure=t}(V||(V={}));var K;(function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"})(K||(K={}));class x extends Ae{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:K.InternalError,r=arguments.length>2?arguments[2]:void 0;super(40,t),this.reason=n,this.participantIdentity=r}}var ue;(function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"})(ue||(ue={}));var X;(function(e){e.KeyRatcheted="keyRatcheted"})(X||(X={}));var le;(function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"})(le||(le={}));var N;(function(e){e.Error="cryptorError"})(N||(N={}));function Te(e){return"type"in e}function Me(e){return R(this,arguments,void 0,function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{name:D},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",t,n,!1,r==="derive"?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}function de(e,t){const r=new TextEncoder().encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:r,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:r,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function te(e,t){return R(this,void 0,void 0,function*(){const n=de(e.algorithm.name,t),r=yield crypto.subtle.deriveKey(n,e,{name:D,length:128},!1,["encrypt","decrypt"]);return{material:e,encryptionKey:r}})}function De(e,t){return R(this,void 0,void 0,function*(){const n=de(e.algorithm.name,t);return crypto.subtle.deriveBits(n,e,256)})}function Fe(e){for(var t=0;t<e.length-3;t++)if(e[t]==0&&e[t+1]==0&&e[t+2]==3)return!0;return!1}function Be(e){const t=[];for(var n=e.length,r=0;r<e.length;)n-r>=3&&!e[r]&&!e[r+1]&&e[r+2]==3?(t.push(e[r++]),t.push(e[r++]),r++):t.push(e[r++]);return new Uint8Array(t)}const Ne=2,fe=3;function Ue(e){const t=[];for(var n=0,r=0;r<e.length;++r){var o=e[r];o<=fe&&n>=Ne&&(t.push(fe),n=0),t.push(o),o==0?++n:n=0}return new Uint8Array(t)}class T{static makeIV(t){const n=new ArrayBuffer(12),r=new DataView(n),o=crypto.getRandomValues(new Uint32Array(1));return r.setUint32(0,o[0]),r.setUint32(4,t),r.setUint32(8,t-T.sendCount%65535),T.sendCount++,n}static encrypt(t,n){return R(this,void 0,void 0,function*(){const r=T.makeIV(performance.now()),o=yield n.getKeySet();if(!o)throw new Error("No key set found");const i=yield crypto.subtle.encrypt({name:D,iv:r},o.encryptionKey,new Uint8Array(t));return{payload:new Uint8Array(i),iv:new Uint8Array(r),keyIndex:n.getCurrentKeyIndex()}})}static decrypt(t,n,r){return R(this,arguments,void 0,function(o,i,c){let v=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,m=arguments.length>4?arguments[4]:void 0,p=arguments.length>5&&arguments[5]!==void 0?arguments[5]:{ratchetCount:0};return function*(){const h=yield c.getKeySet(v);if(!h)throw new Error("No key set found");try{const E=yield crypto.subtle.decrypt({name:D,iv:i},h.encryptionKey,new Uint8Array(o));return{payload:new Uint8Array(E)}}catch(E){if(c.keyProviderOptions.ratchetWindowSize>0)if(p.ratchetCount<c.keyProviderOptions.ratchetWindowSize){d.debug("DataCryptor: ratcheting key attempt ".concat(p.ratchetCount," of ").concat(c.keyProviderOptions.ratchetWindowSize,", for data packet"));let I,S;(m??h)===c.getKeySet(v)&&(S=yield c.ratchetKey(v,!1),I=yield te(S.cryptoKey,c.keyProviderOptions.ratchetSalt));const L=yield T.decrypt(o,i,c,v,m,{ratchetCount:p.ratchetCount+1,encryptionKey:I?.encryptionKey});return L&&I&&(m??h)===c.getKeySet(v)&&(c.setKeySet(I,v,S),c.setCurrentKeyIndex(v)),L}else throw d.warn("DataCryptor: maximum ratchet attempts exceeded"),new x("DataCryptor: valid key missing for participant ".concat(c.participantIdentity),K.InvalidKey,c.participantIdentity);else throw new x("DataCryptor: Decryption failed: ".concat(E.message),K.InvalidKey,c.participantIdentity)}}()})}}T.sendCount=0;var z={exports:{}},he;function We(){if(he)return z.exports;he=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(s,u,l){return Function.prototype.apply.call(s,u,l)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:n=function(s){return Object.getOwnPropertyNames(s)};function r(a){console&&console.warn&&console.warn(a)}var o=Number.isNaN||function(s){return s!==s};function i(){i.init.call(this)}z.exports=i,z.exports.once=y,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var c=10;function v(a){if(typeof a!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof a)}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(a){if(typeof a!="number"||a<0||o(a))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+a+".");c=a}}),i.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||o(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function m(a){return a._maxListeners===void 0?i.defaultMaxListeners:a._maxListeners}i.prototype.getMaxListeners=function(){return m(this)},i.prototype.emit=function(s){for(var u=[],l=1;l<arguments.length;l++)u.push(arguments[l]);var f=s==="error",b=this._events;if(b!==void 0)f=f&&b.error===void 0;else if(!f)return!1;if(f){var g;if(u.length>0&&(g=u[0]),g instanceof Error)throw g;var w=new Error("Unhandled error."+(g?" ("+g.message+")":""));throw w.context=g,w}var k=b[s];if(k===void 0)return!1;if(typeof k=="function")t(k,this,u);else for(var M=k.length,J=L(k,M),l=0;l<M;++l)t(J[l],this,u);return!0};function p(a,s,u,l){var f,b,g;if(v(u),b=a._events,b===void 0?(b=a._events=Object.create(null),a._eventsCount=0):(b.newListener!==void 0&&(a.emit("newListener",s,u.listener?u.listener:u),b=a._events),g=b[s]),g===void 0)g=b[s]=u,++a._eventsCount;else if(typeof g=="function"?g=b[s]=l?[u,g]:[g,u]:l?g.unshift(u):g.push(u),f=m(a),f>0&&g.length>f&&!g.warned){g.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+g.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning",w.emitter=a,w.type=s,w.count=g.length,r(w)}return a}i.prototype.addListener=function(s,u){return p(this,s,u,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(s,u){return p(this,s,u,!0)};function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function E(a,s,u){var l={fired:!1,wrapFn:void 0,target:a,type:s,listener:u},f=h.bind(l);return f.listener=u,l.wrapFn=f,f}i.prototype.once=function(s,u){return v(u),this.on(s,E(this,s,u)),this},i.prototype.prependOnceListener=function(s,u){return v(u),this.prependListener(s,E(this,s,u)),this},i.prototype.removeListener=function(s,u){var l,f,b,g,w;if(v(u),f=this._events,f===void 0)return this;if(l=f[s],l===void 0)return this;if(l===u||l.listener===u)--this._eventsCount===0?this._events=Object.create(null):(delete f[s],f.removeListener&&this.emit("removeListener",s,l.listener||u));else if(typeof l!="function"){for(b=-1,g=l.length-1;g>=0;g--)if(l[g]===u||l[g].listener===u){w=l[g].listener,b=g;break}if(b<0)return this;b===0?l.shift():_(l,b),l.length===1&&(f[s]=l[0]),f.removeListener!==void 0&&this.emit("removeListener",s,w||u)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(s){var u,l,f;if(l=this._events,l===void 0)return this;if(l.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):l[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete l[s]),this;if(arguments.length===0){var b=Object.keys(l),g;for(f=0;f<b.length;++f)g=b[f],g!=="removeListener"&&this.removeAllListeners(g);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(u=l[s],typeof u=="function")this.removeListener(s,u);else if(u!==void 0)for(f=u.length-1;f>=0;f--)this.removeListener(s,u[f]);return this};function I(a,s,u){var l=a._events;if(l===void 0)return[];var f=l[s];return f===void 0?[]:typeof f=="function"?u?[f.listener||f]:[f]:u?C(f):L(f,f.length)}i.prototype.listeners=function(s){return I(this,s,!0)},i.prototype.rawListeners=function(s){return I(this,s,!1)},i.listenerCount=function(a,s){return typeof a.listenerCount=="function"?a.listenerCount(s):S.call(a,s)},i.prototype.listenerCount=S;function S(a){var s=this._events;if(s!==void 0){var u=s[a];if(typeof u=="function")return 1;if(u!==void 0)return u.length}return 0}i.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function L(a,s){for(var u=new Array(s),l=0;l<s;++l)u[l]=a[l];return u}function _(a,s){for(;s+1<a.length;s++)a[s]=a[s+1];a.pop()}function C(a){for(var s=new Array(a.length),u=0;u<s.length;++u)s[u]=a[u].listener||a[u];return s}function y(a,s){return new Promise(function(u,l){function f(g){a.removeListener(s,b),l(g)}function b(){typeof a.removeListener=="function"&&a.removeListener("error",f),u([].slice.call(arguments))}A(a,s,b,{once:!0}),s!=="error"&&O(a,f,{once:!0})})}function O(a,s,u){typeof a.on=="function"&&A(a,"error",s,u)}function A(a,s,u,l){if(typeof a.on=="function")l.once?a.once(s,u):a.on(s,u);else if(typeof a.addEventListener=="function")a.addEventListener(s,function f(b){l.once&&a.removeEventListener(s,f),u(b)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof a)}return z.exports}var ye=We();const je=31;var G;(function(e){e[e.SLICE_NON_IDR=1]="SLICE_NON_IDR",e[e.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",e[e.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",e[e.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",e[e.SLICE_IDR=5]="SLICE_IDR",e[e.SEI=6]="SEI",e[e.SPS=7]="SPS",e[e.PPS=8]="PPS",e[e.AUD=9]="AUD",e[e.END_SEQ=10]="END_SEQ",e[e.END_STREAM=11]="END_STREAM",e[e.FILLER_DATA=12]="FILLER_DATA",e[e.SPS_EXT=13]="SPS_EXT",e[e.PREFIX_NALU=14]="PREFIX_NALU",e[e.SUBSET_SPS=15]="SUBSET_SPS",e[e.DPS=16]="DPS",e[e.SLICE_AUX=19]="SLICE_AUX",e[e.SLICE_EXT=20]="SLICE_EXT",e[e.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT"})(G||(G={}));var P;(function(e){e[e.TRAIL_N=0]="TRAIL_N",e[e.TRAIL_R=1]="TRAIL_R",e[e.TSA_N=2]="TSA_N",e[e.TSA_R=3]="TSA_R",e[e.STSA_N=4]="STSA_N",e[e.STSA_R=5]="STSA_R",e[e.RADL_N=6]="RADL_N",e[e.RADL_R=7]="RADL_R",e[e.RASL_N=8]="RASL_N",e[e.RASL_R=9]="RASL_R",e[e.BLA_W_LP=16]="BLA_W_LP",e[e.BLA_W_RADL=17]="BLA_W_RADL",e[e.BLA_N_LP=18]="BLA_N_LP",e[e.IDR_W_RADL=19]="IDR_W_RADL",e[e.IDR_N_LP=20]="IDR_N_LP",e[e.CRA_NUT=21]="CRA_NUT",e[e.VPS_NUT=32]="VPS_NUT",e[e.SPS_NUT=33]="SPS_NUT",e[e.PPS_NUT=34]="PPS_NUT",e[e.AUD_NUT=35]="AUD_NUT",e[e.EOS_NUT=36]="EOS_NUT",e[e.EOB_NUT=37]="EOB_NUT",e[e.FD_NUT=38]="FD_NUT",e[e.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",e[e.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"})(P||(P={}));function pe(e){return e&je}function ge(e){return e>>1&63}function ve(e){return e===G.SLICE_IDR||e===G.SLICE_NON_IDR}function me(e){return e===P.TRAIL_N||e===P.TRAIL_R||e===P.TSA_N||e===P.TSA_R||e===P.STSA_N||e===P.STSA_R||e===P.RADL_N||e===P.RADL_R||e===P.RASL_N||e===P.RASL_R||e===P.BLA_W_LP||e===P.BLA_W_RADL||e===P.BLA_N_LP||e===P.IDR_W_RADL||e===P.IDR_N_LP||e===P.CRA_NUT}function qe(e,t){for(const n of t){if(ve(pe(e[n])))return"h264";if(me(ge(e[n])))return"h265"}return"unknown"}function Ve(e,t,n){for(const r of t)if(n==="h265"){const o=ge(e[r]);if(me(o))return r+2}else{const o=pe(e[r]);if(ve(o))return r+2}return null}function Xe(e){const t=[];let n=0,r=0,o=e.length-3;for(;r<o;){for(;r<o&&!(r<o-1&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1||e[r]===0&&e[r+1]===0&&e[r+2]===1);)r++;r>=o&&(r=e.length);let i=r;for(;i>n&&e[i-1]===0;)i--;if(n===0){if(i!==n)throw TypeError("byte stream contains leading data")}else t.push(n);let c=3;r<e.length-3&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1&&(c=4),n=r=r+c}return t}function ze(e,t){const n=Xe(e),r=t??qe(e,n);if(r==="unknown")return{unencryptedBytes:0,detectedCodec:r,requiresNALUProcessing:!1};const o=Ve(e,n,r);if(o===null)throw new TypeError("Could not find NALU");return{unencryptedBytes:o,detectedCodec:r,requiresNALUProcessing:!0}}function Ge(e){return R(this,void 0,void 0,function*(){const t=yield crypto.subtle.digest("SHA-256",e),n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")})}const U={VP8KeyFrame8x8:"ef0161653d8b2b23aad46624b420af1d03ce48950e9fc85718028f91b50f9219",H264KeyFrame2x2SPS:"f0a0e09647d891d6d50aa898bce7108090375d0d55e50a2bb21147afee558e44",H264KeyFrame2x2PPS:"61d9665eed71b6d424ae9539330a3bdd5cb386d4d781c808219a6e36750493a7",H264KeyFrame2x2IDR:"faffc26b68a2fc09096fa20f3351e706398b6f838a7500c8063472c2e476e90d",OpusSilenceFrame:"aad8d31fc56b2802ca500e58c2fb9d0b29ad71bb7cb52cd6530251eade188988"};function Ye(e){return R(this,void 0,void 0,function*(){switch(yield Ge(e)){case U.VP8KeyFrame8x8:return"vp8";case U.H264KeyFrame2x2SPS:return"h264";case U.H264KeyFrame2x2PPS:return"h264";case U.H264KeyFrame2x2IDR:return"h264";case U.OpusSilenceFrame:return"opus";default:return null}})}const we=new Map;class Ze extends ye.EventEmitter{encodeFunction(t,n){throw Error("not implemented for subclass")}decodeFunction(t,n){throw Error("not implemented for subclass")}}class Je extends Ze{constructor(t){var n;super(),this.lastErrorTimestamp=new Map,this.errorCounts=new Map,this.ERROR_THROTTLE_MS=1e3,this.MAX_ERRORS_PER_MINUTE=5,this.ERROR_WINDOW_MS=6e4,this.sendCounts=new Map,this.keys=t.keys,this.participantIdentity=t.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=t.keyProviderOptions,this.sifTrailer=(n=t.sifTrailer)!==null&&n!==void 0?n:Uint8Array.from([])}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(t,n){d.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{newParticipant:t,hadPreviousParticipant:!!this.participantIdentity})),this.participantIdentity&&this.participantIdentity!==t&&(d.warn("cryptor has already a participant set, cleaning up before switching",{oldParticipant:this.participantIdentity,newParticipant:t,trackId:this.trackId}),this.unsetParticipant()),this.participantIdentity=t,this.keys=n}unsetParticipant(){d.debug("unsetting participant",this.logContext),this.currentTransform&&(this.currentTransform=void 0),this.participantIdentity=void 0,this.lastErrorTimestamp=new Map,this.errorCounts=new Map}isEnabled(){if(this.participantIdentity)return we.get(this.participantIdentity)}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(t){this.videoCodec=t}setRtpMap(t){this.rtpMap=t}setupTransform(t,n,r,o,i,c){if(c&&(d.info("setting codec on cryptor to",{codec:c}),this.videoCodec=c),d.debug("Setting up frame cryptor transform",Object.assign({operation:t,passedTrackId:o,codec:c,isReuse:i,hasCurrentTransform:!!this.currentTransform},this.logContext)),this.trackId=o,i&&this.currentTransform&&n===this.currentTransform.readable&&r===this.currentTransform.writable){d.debug("reusing existing transform",Object.assign(Object.assign({},this.logContext),{trackId:o}));return}const v=Symbol("transform"),m=t==="encode"?this.encodeFunction:this.decodeFunction,p=new TransformStream({transform:m.bind(this)});this.currentTransform={readable:n,writable:r,transformer:p,trackId:o,symbol:v},n.pipeThrough(p).pipeTo(r).catch(h=>{h instanceof TypeError&&h.message==="Destination stream closed"?d.debug("destination stream closed"):(d.warn("transform error",Object.assign({error:h},this.logContext)),this.emit(N.Error,h instanceof x?h:new x(h.message,void 0,this.participantIdentity)))}).finally(()=>{var h;((h=this.currentTransform)===null||h===void 0?void 0:h.symbol)===v&&(d.debug("transform completed",Object.assign(Object.assign({},this.logContext),{trackId:o})),this.currentTransform=void 0)})}setSifTrailer(t){d.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:t})),this.sifTrailer=t}shouldEmitError(t){var n,r;const o=Date.now(),i=(n=this.lastErrorTimestamp.get(t))!==null&&n!==void 0?n:0,c=(r=this.errorCounts.get(t))!==null&&r!==void 0?r:0;return o-i>this.ERROR_WINDOW_MS?(this.errorCounts.set(t,0),this.lastErrorTimestamp.set(t,o),!0):o-i<this.ERROR_THROTTLE_MS?!1:c>=this.MAX_ERRORS_PER_MINUTE?(c===this.MAX_ERRORS_PER_MINUTE&&(d.warn("Suppressing further decryption errors for ".concat(this.participantIdentity),Object.assign(Object.assign({},this.logContext),{errorKey:t})),this.errorCounts.set(t,c+1)),!1):(this.lastErrorTimestamp.set(t,o),this.errorCounts.set(t,c+1),!0)}emitThrottledError(t){var n;const r="".concat(this.participantIdentity,"-").concat(t.reason,"-decrypt");if(this.shouldEmitError(r)){const o=(n=this.errorCounts.get(r))!==null&&n!==void 0?n:0;o>1&&d.debug("Decryption error (".concat(o," occurrences in window)"),Object.assign(Object.assign({},this.logContext),{reason:K[t.reason]})),this.emit(N.Error,t)}}encodeFunction(t,n){return R(this,void 0,void 0,function*(){var r;if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);const o=this.keys.getKeySet();if(!o){this.emitThrottledError(new x("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()),K.MissingKey,this.participantIdentity));return}const{encryptionKey:i}=o,c=this.keys.getCurrentKeyIndex();if(i){const m=this.makeIV((r=t.getMetadata().synchronizationSource)!==null&&r!==void 0?r:-1,t.timestamp);let p=this.getUnencryptedBytes(t);const h=new Uint8Array(t.data,0,p.unencryptedBytes),E=new Uint8Array(2);E[0]=oe,E[1]=c;try{const I=yield crypto.subtle.encrypt({name:D,iv:m,additionalData:new Uint8Array(t.data,0,h.byteLength)},i,new Uint8Array(t.data,p.unencryptedBytes));let S=new Uint8Array(I.byteLength+m.byteLength+E.byteLength);S.set(new Uint8Array(I)),S.set(new Uint8Array(m),I.byteLength),S.set(E,I.byteLength+m.byteLength),p.requiresNALUProcessing&&(S=Ue(S));var v=new Uint8Array(h.byteLength+S.byteLength);return v.set(h),v.set(S,h.byteLength),t.data=v.buffer,n.enqueue(t)}catch(I){d.error(I)}}else d.debug("failed to encrypt, emitting error",this.logContext),this.emitThrottledError(new x("encryption key missing for encoding",K.MissingKey,this.participantIdentity))})}decodeFunction(t,n){return R(this,void 0,void 0,function*(){if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);if($e(t.data,this.sifTrailer)){if(t.data=t.data.slice(0,t.data.byteLength-this.sifTrailer.byteLength),yield Ye(t.data))return d.debug("enqueue SIF",this.logContext),n.enqueue(t);d.warn("Unexpected SIF frame payload, dropping frame",this.logContext);return}const o=new Uint8Array(t.data)[t.data.byteLength-1];if(!this.keys.hasInvalidKeyAtIndex(o))if(this.keys.getKeySet(o))try{const i=yield this.decryptFrame(t,o);if(this.keys.decryptionSuccess(o),i)return n.enqueue(i)}catch(i){i instanceof x&&i.reason===K.InvalidKey?this.keys.hasValidKey&&(this.emitThrottledError(i),this.keys.decryptionFailure(o)):d.warn("decoding frame failed",{error:i})}else d.warn("skipping decryption due to missing key at index ".concat(o)),this.emitThrottledError(new x("missing key at index ".concat(o," for participant ").concat(this.participantIdentity),K.MissingKey,this.participantIdentity)),this.keys.decryptionFailure(o)})}decryptFrame(t,n){return R(this,arguments,void 0,function(r,o){var i=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,v=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{ratchetCount:0};return function*(){var m;const p=i.keys.getKeySet(o);if(!v.encryptionKey&&!p)throw new TypeError("no encryption key found for decryption of ".concat(i.participantIdentity));let h=i.getUnencryptedBytes(r);try{const I=new Uint8Array(r.data,0,h.unencryptedBytes);var E=new Uint8Array(r.data,I.length,r.data.byteLength-I.length);if(h.requiresNALUProcessing&&Fe(E)){E=Be(E);const s=new Uint8Array(I.byteLength+E.byteLength);s.set(I),s.set(E,I.byteLength),r.data=s.buffer}const S=new Uint8Array(r.data,r.data.byteLength-2,2),L=S[0],_=new Uint8Array(r.data,r.data.byteLength-L-S.byteLength,L),C=I.byteLength,y=r.data.byteLength-(I.byteLength+L+S.byteLength),O=yield crypto.subtle.decrypt({name:D,iv:_,additionalData:new Uint8Array(r.data,0,I.byteLength)},(m=v.encryptionKey)!==null&&m!==void 0?m:p.encryptionKey,new Uint8Array(r.data,C,y)),A=new ArrayBuffer(I.byteLength+O.byteLength),a=new Uint8Array(A);return a.set(new Uint8Array(r.data,0,I.byteLength)),a.set(new Uint8Array(O),I.byteLength),r.data=A,r}catch(I){if(i.keyProviderOptions.ratchetWindowSize>0)if(v.ratchetCount<i.keyProviderOptions.ratchetWindowSize){d.debug("ratcheting key attempt ".concat(v.ratchetCount," of ").concat(i.keyProviderOptions.ratchetWindowSize,", for kind ").concat(r instanceof RTCEncodedAudioFrame?"audio":"video"));let S,L;(c??p)===i.keys.getKeySet(o)&&(L=yield i.keys.ratchetKey(o,!1),S=yield te(L.cryptoKey,i.keyProviderOptions.ratchetSalt));const _=yield i.decryptFrame(r,o,c||p,{ratchetCount:v.ratchetCount+1,encryptionKey:S?.encryptionKey});return _&&S&&(c??p)===i.keys.getKeySet(o)&&(i.keys.setKeySet(S,o,L),i.keys.setCurrentKeyIndex(o)),_}else throw d.warn("maximum ratchet attempts exceeded"),new x("valid key missing for participant ".concat(i.participantIdentity),K.InvalidKey,i.participantIdentity);else throw new x("Decryption failed: ".concat(I.message),K.InvalidKey,i.participantIdentity)}}()})}makeIV(t,n){var r;const o=new ArrayBuffer(oe),i=new DataView(o);this.sendCounts.has(t)||this.sendCounts.set(t,Math.floor(Math.random()*65535));const c=(r=this.sendCounts.get(t))!==null&&r!==void 0?r:0;return i.setUint32(0,t),i.setUint32(4,n),i.setUint32(8,n-c%65535),this.sendCounts.set(t,c+1),o}getUnencryptedBytes(t){var n;if(!Te(t))return{unencryptedBytes:ee.audio,requiresNALUProcessing:!1};const r=(n=this.getVideoCodec(t))!==null&&n!==void 0?n:this.videoCodec;if(r!==this.detectedCodec&&(d.debug("detected different codec",Object.assign({detectedCodec:r,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=r),r==="av1")throw new Error("".concat(r," is not yet supported for end to end encryption"));if(r==="vp8")return{unencryptedBytes:ee[t.type],requiresNALUProcessing:!1};if(r==="vp9")return{unencryptedBytes:0,requiresNALUProcessing:!1};try{const o=r==="h264"||r==="h265"?r:void 0,i=ze(new Uint8Array(t.data),o);if(i.requiresNALUProcessing)return{unencryptedBytes:i.unencryptedBytes,requiresNALUProcessing:!0}}catch(o){d.debug("NALU processing failed, falling back to VP8 handling",Object.assign({error:o},this.logContext))}return{unencryptedBytes:ee[t.type],requiresNALUProcessing:!1}}getVideoCodec(t){if(this.rtpMap.size===0)return;const n=t.getMetadata().payloadType;return n?this.rtpMap.get(n):void 0}}function $e(e,t){if(t.byteLength===0)return!1;const n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((r,o)=>r===n[o])}class Ie extends ye.EventEmitter{get hasValidKey(){return!this.hasInvalidKeyAtIndex(this.currentKeyIndex)}constructor(t,n){if(super(),this.currentKeyIndex=0,n.keyringSize<1||n.keyringSize>256)throw new TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=new Array(n.keyringSize).fill(void 0),this.decryptionFailureCounts=new Array(n.keyringSize).fill(0),this.keyProviderOptions=n,this.ratchetPromiseMap=new Map,this.participantIdentity=t}hasInvalidKeyAtIndex(t){return this.keyProviderOptions.failureTolerance>=0&&this.decryptionFailureCounts[t]>this.keyProviderOptions.failureTolerance}decryptionFailure(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.currentKeyIndex;this.keyProviderOptions.failureTolerance<0||(this.decryptionFailureCounts[t]+=1,this.decryptionFailureCounts[t]>this.keyProviderOptions.failureTolerance&&d.warn("key for ".concat(this.participantIdentity," at index ").concat(t," is being marked as invalid")))}decryptionSuccess(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.currentKeyIndex;this.resetKeyStatus(t)}resetKeyStatus(t){t===void 0?this.decryptionFailureCounts.fill(0):this.decryptionFailureCounts[t]=0}ratchetKey(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;const r=t??this.getCurrentKeyIndex(),o=this.ratchetPromiseMap.get(r);if(typeof o<"u")return o;const i=new Promise((c,v)=>R(this,void 0,void 0,function*(){try{const m=this.getKeySet(r);if(!m)throw new TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));const p=m.material,h=yield De(p,this.keyProviderOptions.ratchetSalt),E=yield Me(h,p.algorithm.name,"derive"),I={chainKey:h,cryptoKey:E};n&&(yield this.setKeyFromMaterial(E,r,I)),c(I)}catch(m){v(m)}finally{this.ratchetPromiseMap.delete(r)}}));return this.ratchetPromiseMap.set(r,i),i}setKey(t){return R(this,arguments,void 0,function(n){var r=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return function*(){yield r.setKeyFromMaterial(n,o),r.resetKeyStatus(o)}()})}setKeyFromMaterial(t,n){return R(this,arguments,void 0,function(r,o){var i=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;return function*(){const v=yield te(r,i.keyProviderOptions.ratchetSalt),m=o>=0?o%i.cryptoKeyRing.length:i.currentKeyIndex;d.debug("setting new key with index ".concat(o),{usage:r.usages,algorithm:r.algorithm,ratchetSalt:i.keyProviderOptions.ratchetSalt}),i.setKeySet(v,m,c),m>=0&&(i.currentKeyIndex=m)}()})}setKeySet(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;this.cryptoKeyRing[n%this.cryptoKeyRing.length]=t,r&&this.emit(X.KeyRatcheted,r,this.participantIdentity,n)}setCurrentKeyIndex(t){return R(this,void 0,void 0,function*(){this.currentKeyIndex=t%this.cryptoKeyRing.length,this.resetKeyStatus(t)})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(t){return this.cryptoKeyRing[t??this.currentKeyIndex]}}const W=[],_e=new Map;let ne,Qe=new Ke,He=!1,Y=!1,be,j=Oe,Se=new Map;d.setDefaultLevel("info"),onmessage=e=>{Qe.run(()=>R(void 0,void 0,void 0,function*(){const{kind:t,data:n}=e.data;switch(t){case"init":d.setLevel(n.loglevel),d.info("worker initialized"),j=n.keyProviderOptions,Y=!!n.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:He}});break;case"enable":nt(n.enabled,n.participantIdentity),d.info("updated e2ee enabled status for ".concat(n.participantIdentity," to ").concat(n.enabled)),postMessage(e.data);break;case"decode":Z(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.isReuse,n.codec);break;case"encode":Z(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.isReuse,n.codec);break;case"encryptDataRequest":const{payload:c,iv:v,keyIndex:m}=yield T.encrypt(n.payload,F(n.participantIdentity));console.log("encrypted payload",{original:n.payload,encrypted:c,iv:v}),postMessage({kind:"encryptDataResponse",data:{payload:c,iv:v,keyIndex:m,uuid:n.uuid}});break;case"decryptDataRequest":try{const{payload:p}=yield T.decrypt(n.payload,n.iv,F(n.participantIdentity),n.keyIndex);postMessage({kind:"decryptDataResponse",data:{payload:p,uuid:n.uuid}})}catch(p){d.error("DataCryptor decryption failed",{error:p,participantIdentity:n.participantIdentity,uuid:n.uuid}),postMessage({kind:"error",data:{error:p instanceof Error?p:new Error(String(p)),uuid:n.uuid}})}break;case"setKey":Y?yield rt(n.key,n.keyIndex):n.participantIdentity?(d.info("set participant sender key ".concat(n.participantIdentity," index ").concat(n.keyIndex)),yield F(n.participantIdentity).setKey(n.key,n.keyIndex)):d.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":tt(n.trackId,n.participantIdentity);break;case"updateCodec":Z(n.participantIdentity,n.trackId).setVideoCodec(n.codec),d.info("updated codec",{participantIdentity:n.participantIdentity,trackId:n.trackId,codec:n.codec});break;case"setRTPMap":Se=n.map,W.forEach(p=>{p.getParticipantIdentity()===n.participantIdentity&&p.setRtpMap(n.map)});break;case"ratchetRequest":et(n);break;case"setSifTrailer":ot(n.trailer);break}}))};function et(e){return R(this,void 0,void 0,function*(){if(Y){const t=re();yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else if(e.participantIdentity){const t=F(e.participantIdentity);yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else d.error("no participant Id was provided for ratchet request and shared key usage is disabled")})}function Z(e,t){let n=W.filter(o=>o.getTrackId()===t);if(n.length>1){const o=n.map(i=>({participant:i.getParticipantIdentity()})).join(",");d.error("Found multiple cryptors for the same trackID ".concat(t,". target participant: ").concat(e," "),{participants:o})}let r=n[0];if(r)e!==r.getParticipantIdentity()&&r.setParticipant(e,F(e));else{if(d.info("creating new cryptor for",{participantIdentity:e,trackId:t}),!j)throw Error("Missing keyProvider options");r=new Je({participantIdentity:e,keys:F(e),keyProviderOptions:j,sifTrailer:be}),r.setRtpMap(Se),it(r),W.push(r)}return r}function F(e){if(Y)return re();let t=_e.get(e);return t||(t=new Ie(e,j),t.on(X.KeyRatcheted,st),_e.set(e,t)),t}function re(){return ne||(d.debug("creating new shared key handler"),ne=new Ie("shared-key",j)),ne}function tt(e,t){const n=W.filter(o=>o.getParticipantIdentity()===t&&o.getTrackId()===e);n.length>1&&d.error("Found multiple cryptors for the same participant and trackID combination",{trackId:e,participantIdentity:t});const r=n[0];r?r.unsetParticipant():d.warn("Could not unset participant on cryptor",{trackId:e,participantIdentity:t})}function nt(e,t){d.debug("setting encryption enabled for all tracks of ".concat(t),{enable:e}),we.set(t,e)}function rt(e,t){return R(this,void 0,void 0,function*(){d.info("set shared key",{index:t}),yield re().setKey(e,t)})}function it(e){e.on(N.Error,t=>{const n={kind:"error",data:{error:new Error("".concat(K[t.reason],": ").concat(t.message)),participantIdentity:t.participantIdentity}};postMessage(n)})}function st(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,ratchetResult:e}})}function ot(e){be=e,W.forEach(t=>{t.setSifTrailer(e)})}self.RTCTransformEvent&&(d.debug("setup transform event"),self.onrtctransform=e=>{const t=e.transformer;d.debug("transformer",t);const{kind:n,participantIdentity:r,trackId:o,codec:i}=t.options,c=Z(r,o);d.debug("transform",{codec:i}),c.setupTransform(n,t.readable,t.writable,o,!1,i)})})();
//# sourceMappingURL=livekit-client.e2ee.worker-Bc8nUFw7.js.map
